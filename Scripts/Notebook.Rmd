---
author: "Elliot Johnson-Hall"
date: "November 2022"
title: "Contraception and Covid-19 Restrictions in Scotland"
output:
  pdf_document: default
---
# Setup Chunks

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r LoadLibraries, message=FALSE, warning=FALSE}
if(!require(pacman))install.packages("pacman")
pacman::p_load("gtExtras", "tidyverse", "lubridate", "readxl", "ggplot2", "gt", "here", "colorspace", "patchwork")
```

# Data Import and Wrangle

## Setup custom functions


```{r CustomFunctions}
#This function will perform an analysis pipeline on the data in a DRY way.
Wrangle <- function(DatasetToWrangle)
{DatasetToWrangle <- DatasetToWrangle %>%
    filter(GPPractice %in% GPPractices$GPPractice) %>%
    mutate(HB = case_when(is.na(HBT) ~ HBT2014, !is.na(HBT) ~ HBT)) %>%
    select(-c(HBT2014, HBT, ClassOfPreparationCode, NumberOfPaidItems, GrossIngredientCost))
  DatasetToWrangle <-
    full_join(DatasetToWrangle, HealthBoards, by = "HB") %>% 
    full_join(., GPPractices, by = "GPPractice") %>%
    mutate(HB = HB.x) %>% 
    full_join(., SIMD, by = c("DataZone", "HB"))%>%
    select(-c(HB.x, HB.y, DZ, HBcode)) %>%
    drop_na() %>%
    mutate(HealthBoard = HB, SIMDOverallRank = SIMD2020v2_Vigintile, SIMDHealthRank = SIMD2020_Health_Domain_Rank, UrbanRuralCode = URclass, UrbanRuralDescription = URname) %>%
    select(-c(HB, SIMD2020v2_Vigintile, SIMD2020_Health_Domain_Rank, URclass, URname)) %>%
    mutate(HealthBoard = as.factor(HealthBoard), SIMDOverallRank = as.factor(SIMDOverallRank), SIMDHealthRank = as.factor(SIMDHealthRank), UrbanRuralCode = as.factor(UrbanRuralCode), UrbanRuralDescription = as.factor(UrbanRuralDescription), Postcode = as.factor(Postcode), DataZone = as.factor(DataZone), HBName = as.factor(HBName), HealthBoardCode = as.factor(HealthBoardCode), GPPractice = as.factor(GPPractice), PaidDateMonth = ymd(PaidDateMonth))
  return(DatasetToWrangle)}

#This zooms in on dates around lockdowns for plotting
Zoom <- function(DatasetToZoom) {DatasetToZoom %>%
  group_by(PaidDateMonth) %>%
  filter(as_date(PaidDateMonth) >= as_date("2020-01-01")) %>% 
  summarise(SumPaidQuantity = sum(PaidQuantity), .groups = 'drop')}

#Highlights periods of lockdown
AnnotateLockdowns <- function(Plot) {
  annotate(geom = "rect",
    xmin = c(dmy("23/03/2020"), dmy("26/12/2020"), dmy("26/12/2021")),
    xmax = c(dmy("19/07/2020"), dmy("16/04/2021"), dmy("21/03/2022")),
    ymin = c(-Inf, -Inf, -Inf),
    ymax = c(Inf, Inf, Inf),
  fill = "yellow", alpha = 0.25) }

#Custom ggplot theme
ThemeElliot <- function(Plot) {
  theme_minimal(base_size=12, base_family="Avenir") +
    theme(
      legend.position = "none",
      plot.title = element_text(hjust = 0.5, face = "bold", size = 18),
      panel.grid.minor.y=element_blank(),
      axis.title.x = element_text(face = "bold"),
      axis.title.y = element_text(face = "bold", angle = 90, margin = margin(r = 5)),
      axis.text.y = element_text(angle = 45),
      strip.text = element_text(face = "italic"),
      axis.text.x.bottom = 
        element_text(angle = 45, margin = margin(t = 10)),
    plot.margin = margin(5, 5, 5, 5))}
```

## Prescriptions in the Community Data

This chunk builds a tibble of the two vectors above. It also includes
some use of `lubridate` functions to perform some data wrangling.

This chunk imports all the data from the NHS Scotland Open Data website
and stores each month as an R dataframe. This will take an hour or more
to run!

```{r URLWrangle, message=FALSE, results='hide'}
URLList <- read_csv("https://raw.githubusercontent.com/s1906007/expert-octo-pancake/main/Data/URLList.csv") %>% 
  mutate(YearMonths = ym(YearMonths)) %>% 
  mutate(Month = month(YearMonths)) %>% 
  mutate(Year = year(YearMonths))
#Wrangle
URLList <- URLList %>% 
  mutate(MonthYear = paste0(Year, Month))
for (row in 1:nrow(URLList)) {
  assign(paste0("DF", URLList$MonthYear[row]), read_csv(URLList$URLs[row]))
  row = row + 1}
#RegExBindDataFrames
DFList <- mget(ls(pattern = "DF20"))
CompletePrescriptionDataset <- bind_rows(DFList)
rm(list = ls(pattern = "DF"))
```

## Other Datasets

We'll also import three more datasets. Health Board names and codes, GP
Practice data and codes, and the Scottish Index of Multiple Deprivation
data from 2020.

```{r LoadAndWrangleOtherDatasets, message=FALSE, warning=FALSE}
#Health Boards
HBCodes <- read_csv("https://raw.githubusercontent.com/s1906007/expert-octo-pancake/main/Data/HBCodes.csv")
HealthBoards <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv")
HealthBoards <- HealthBoards %>% select(c(HB, HBName))
HealthBoards <- full_join(HealthBoards, HBCodes %>% select(-HBName), by = "HB")

#Scottish Index of Multiple Deprivation
download.file("https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2020/01/scottish-index-of-multiple-deprivation-2020-data-zone-look-up-file/documents/scottish-index-of-multiple-deprivation-data-zone-look-up/scottish-index-of-multiple-deprivation-data-zone-look-up/govscot%3Adocument/SIMD%2B2020v2%2B-%2Bdatazone%2Blookup.xlsx", (here("Data", "SIMD.xlsx")))

SIMD <- read_excel((here("Data", "SIMD.xlsx")), sheet = 3)
SIMD <- SIMD %>%
  select(c(DZ, SIMD2020v2_Vigintile, SIMD2020_Health_Domain_Rank, Population, URclass, URname, HBcode)) %>%
  mutate(DataZone = DZ, HB = HBcode)

#GP Practices
CommunityPharmacies <- list(99998, 5295403, "ALL SCO", "S92000003", "S92000003")
GPPractices <- read_csv("https://www.opendata.nhs.scot/dataset/f23655c3-6e23-4103-a511-a80d998adb90/resource/1a15cb34-fcf9-4d3f-ad63-1ba3e675fbe2/download/practice_contactdetails_oct2022-open-data.csv")
GPPractices <- GPPractices %>%
  mutate(GPPractice = PracticeCode) %>% 
  select(c(GPPractice, PracticeListSize, Postcode, HB, DataZone)) %>% 
  rbind(., CommunityPharmacies)

#Numbers of women who would be elegible for contraceptive prescriptions
download.file("https://www.scotlandscensus.gov.uk/media/rfzlmc3l/scotland-blk.zip", here("Data", "scotland-blk.zip"))
AgeBySex <- read_csv(unzip(here("Data", "scotland-blk.zip"), files = "DC1117SC.csv", exdir = here("Data")))
ReproActive <- AgeBySex %>%
  mutate(Age = ...2) %>%
  select(Age, Females) %>%
  filter(between(Age, 16, 49))
ReproNum <- sum(ReproActive[["Females"]])
```

# Contraception Data

```{r ContraceptionData, message=FALSE, warning=FALSE}
#Injections
Injection <- CompletePrescriptionDataset %>% 
  filter(str_detect(BNFItemCode, "0703022M"))
#Intra-Uterine Systems
IUS <- CompletePrescriptionDataset %>% 
  filter(str_detect(BNFItemCode, "0703023"))
#Intra-Uterine Devices
IUD <- CompletePrescriptionDataset %>% 
  filter(str_detect(BNFItemCode, "21040"))
#Implants
Implant <- CompletePrescriptionDataset %>% 
  filter(str_detect(BNFItemDescription, "NEXPLANON"))
#Long Acting Reversible Contraception
LARCList <- list(IUD, IUS, Implant, Injection)
LARC <- map_df(LARCList, Wrangle)
#Emergency Contraception
EmergencyContraception <- CompletePrescriptionDataset %>% 
  filter(str_detect(BNFItemCode, "0703050")) %>% 
  Wrangle(.)
#Combined Oral Contraceptives and Progesterone-only Oral Contraceptives
Tablet <- CompletePrescriptionDataset %>%
  filter(str_detect(BNFItemCode, "0703010")) %>%
  filter(str_detect(BNFItemDescription, "TAB")) %>% 
  rbind(., CompletePrescriptionDataset %>% 
          filter(str_detect(BNFItemCode, "0703021"))) %>%
  Wrangle(.)
```

```{r PlottingLARCData, warning=FALSE, message=FALSE}
#Data Labels for Health Boards
HealthBoardLabels <- c("NHS Ayrshire and Arran", "NHS Borders", "NHS Dumfries and Galloway", "NHS Fife", "NHS Forth Valley", "NHS Grampian", "NHS Greater Glasgow and Clyde", "NHS Highland", "NHS Lanarkshire", "NHS Lothian", "NHS Orkney", "NHS Shetland", "NHS Tayside", "NHS Western Isles")
names(HealthBoardLabels) <- c("AaA", "Bor", "DaG", "Fif", "FoV", "Gra", "GGC", "Hig", "Lan", "Lot", "Ork", "She", "Tay", "WIs")
#Plot LARC Prescription Trends per Month per Health Board (Panel A)
LARCPlot <- LARC %>%
  group_by(PaidDateMonth, HealthBoardCode) %>%
  summarise(SumPaidQuantity = sum(PaidQuantity), .groups = 'drop') %>%
  ggplot(aes(x = PaidDateMonth, y = SumPaidQuantity)) +
  AnnotateLockdowns() +
  geom_line(mapping = aes(colour = HealthBoardCode)) +
  geom_point(mapping = aes(colour = HealthBoardCode), shape = 1) +
  scale_y_continuous(labels= scales::comma, n.breaks = 3) +
  scale_x_date() +
  scale_color_discrete_qualitative(palette = "Pastel1") +
  facet_wrap(~ HealthBoardCode, ncol = 2, scales = "free_y", shrink = TRUE,
    labeller = labeller(HealthBoardCode = HealthBoardLabels)) +
  labs(title = "LARC Issued by NHS Scotland by Health Board", 
       x = "Month and Year Prescription Dispensed", 
       y = "Sum of Prescriptions Issued") +
  ThemeElliot()
#Plot LARC Prescription Trends per Month for all of Scotland (Panel B)
LARCPlotScotland <- LARC %>%
  group_by(PaidDateMonth) %>%
  summarise(SumPaidQuantity = sum(PaidQuantity), .groups = 'drop') %>%
  ggplot(aes(x = PaidDateMonth, y = SumPaidQuantity)) +
  AnnotateLockdowns() +
  geom_line(colour = "#0391BF") +
  geom_point(colour = "#0391BF", shape = 1) +
  scale_x_date() +
  labs(title = "LARC Prescriptions \n Issued by NHS Scotland", 
       x = "Month and Year Prescription Dispensed", 
       y = "Sum of Prescriptions Issued") +
  ThemeElliot()
#Plot LARC Prescription Trends per Month for all of Scotland but zoomed in on 2020 to 2022 (Panel C)
LARCPlotScotlandZoomed <- Zoom(LARC)%>%
  ggplot(aes(x = PaidDateMonth, y = SumPaidQuantity)) +
  AnnotateLockdowns() +
  geom_line(colour = "#0391BF") +
  geom_point(colour = "#0391BF", shape = 1) +
  scale_x_date(date_breaks="2 months", 
               date_labels = "%b '%y", 
               minor_breaks = NULL) +
  labs(title = "LARC Prescriptions Issued by NHS \n Scotland from Jan 2020 to Jul 2022", 
       x = "Month and Year Prescription Dispensed", 
       y = "Sum of Prescriptions Issued") +
  ThemeElliot()
#Now to put Panels A, B & C together to make one plot with `patchwork`
LARCPlotsPatchwork <- wrap_plots(LARCPlot, LARCPlotScotland / LARCPlotScotlandZoomed) +
  plot_layout(widths = c(2,1)) + 
  plot_annotation(
    caption = 'N.B. Scales are free on these plots. For Panel A, Health Boards began reporting at different times hence data is missing for some years in some plots. Yellow shaded areas indicate national lockdowns in Scotland.',
 tag_levels = 'A',
    title = "Change in Prescribing Rates of Long Acting Reversible \n Contraception in Scotland over Covid-19 Lockdowns",
 theme = theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 18), plot.margin = margin(5, 5, 5, 5)))

LARCPlotsPatchwork
```

```{r LARCTableTimePeriods}
LARC %>%
  select(PaidDateMonth, PaidQuantity, HealthBoardCode) %>%
  group_by(PaidDateMonth) %>% 
  summarise(SumPaidQuantity = sum(PaidQuantity), NumberHealthBoards = n_distinct(HealthBoardCode), NumberMonths = n_distinct(PaidDateMonth), .groups = 'drop') %>% 
  mutate(TimePeriod = case_when(
    PaidDateMonth < as_date("2020-03-22") ~ "Pre-Covid", 
    between(PaidDateMonth, as_date("2020-03-2"), as_date("2020-07-19")) ~ "Lockdown 1",
    between(PaidDateMonth, as_date("2020-07-20"), as_date("2020-12-25")) ~
      "Post-Lockdown 1",
    between(PaidDateMonth, as_date("2020-12-26"), as_date("2021-04-16")) ~
      "Lockdown 2",
    between(PaidDateMonth, as_date("2021-04-17"), as_date("2021-12-25")) ~
      "Post-Lockdown 2",
    between(PaidDateMonth, as_date("2021-12-26"), as_date("2022-03-21")) ~
      "Lockdown 3",
    PaidDateMonth > as_date("2022-03-22") ~ "Post-Lockdown 3"
    )) %>% 
  mutate(TimePeriodDates = case_when(
    TimePeriod == "Pre-Covid" ~ "01/10/2015 - 22/03/2020",
    TimePeriod == "Lockdown 1" ~ "23/03/2020 - 19/07/2020",
    TimePeriod == "Post-Lockdown 1" ~ "20/07/2020 - 25/12/2020",
    TimePeriod == "Lockdown 2" ~ "26/12/2020 - 16/04/2021",
    TimePeriod == "Post-Lockdown 2" ~ "17/04/2021 - 25/12/2021",
    TimePeriod == "Lockdown 3" ~ "26/12/2021 - 21/03/2022",
    TimePeriod == "Post-Lockdown 3" ~ "22/03/2022 - 01/07/2022"
    )) %>% 
    mutate(MeanPrescriptionsDispensedPerHealthBoardPerMonth = ((SumPaidQuantity/NumberHealthBoards)/NumberMonths)) %>% 
  group_by(TimePeriod) %>% 
    mutate(MeanPrescriptionsDispensedPerHealthBoardPerTimePeriod = (mean(MeanPrescriptionsDispensedPerHealthBoardPerMonth))) %>% 
  select(TimePeriod, MeanPrescriptionsDispensedPerHealthBoardPerTimePeriod, TimePeriodDates) %>%
  distinct(TimePeriod, TimePeriodDates, MeanPrescriptionsDispensedPerHealthBoardPerTimePeriod) %>% 
  tibble() %>% 
  mutate(PercentageChange = round( ((MeanPrescriptionsDispensedPerHealthBoardPerTimePeriod/lag(MeanPrescriptionsDispensedPerHealthBoardPerTimePeriod) *100) -100), 0)) %>% 
  mutate(PercentageChange = case_when(
    PercentageChange > 0 ~ paste0("+", PercentageChange, "%", " ↑"),
    PercentageChange < 0 ~ paste0( PercentageChange, "%", " ↓"))) %>% 
  gt() %>% 
  tab_header(title = "Mean Quantities of Long Acting Reversible Contraception Dispensed by NHS Scotland") %>% 
  fmt_integer(MeanPrescriptionsDispensedPerHealthBoardPerTimePeriod) %>%
  cols_label(TimePeriod = "Time Period", TimePeriodDates = "Dates", MeanPrescriptionsDispensedPerHealthBoardPerTimePeriod = "Mean LARC \n Prescriptions Dispensed", PercentageChange = "Percentage Change") %>% 
  cols_move(PercentageChange, after = MeanPrescriptionsDispensedPerHealthBoardPerTimePeriod) %>%  cols_move(TimePeriodDates, after = TimePeriod) %>%
  gt_theme_guardian() %>% 
  tab_style(style = list(cell_text(color = "red")),
    locations = cells_body(columns = PercentageChange, rows = c(2, 7))) %>% 
    tab_style(style = list(cell_text(color = "chartreuse4")),
    locations = cells_body(columns = PercentageChange, rows = c(3, 4, 5, 6)))
```

```{r ZoomedPlots, warning=FALSE}
ContraceptivesLogPlot <- Zoom(EmergencyContraception) %>%
  ggplot(aes(x = PaidDateMonth, y = SumPaidQuantity)) +
   annotate(geom = "rect",
    xmin = c(dmy("19/07/2020"), dmy("16/04/2021"), dmy("21/03/2022")),
    xmax = c(dmy("19/08/2020"), dmy("16/05/2021"), dmy("21/04/2022")),
    ymin = c(0, 0, 0),
    ymax = c(10000000, 10000000, 10000000),
  fill = "green", alpha = 0.25) +
   annotate(geom = "rect",
    xmin = c(dmy("23/03/2020"), dmy("26/12/2020"), dmy("26/12/2021")),
    xmax = c(dmy("19/07/2020"), dmy("16/04/2021"), dmy("21/03/2022")),
      ymin = c(0, 0, 0),
    ymax = c(10000000, 10000000, 10000000),
  fill = "yellow", alpha = 0.25) +
  geom_line(aes(y = SumPaidQuantity)) +
  geom_line(
    data = Zoom(Tablet),
    colour = "red"
  ) +
  geom_line(
    data = Zoom(LARC),
    colour = "blue"
  ) +
  scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x)
      10 ^ x),
    labels = scales::trans_format("log10", scales::math_format(10 ^ .x))
  ) +
  ThemeElliot() +
  annotation_logticks(sides = "l") +
  labs(title = "Changes in Contraception Prescriptions in Scotland over Time")

LARCZoomPlot <- Zoom(LARC) %>%
  ggplot(aes(x = PaidDateMonth, y = SumPaidQuantity)) +
  AnnotateLockdowns() +
  geom_line(colour = "#0391BF") +
  geom_point(colour = "#0391BF", shape = 1) +
  scale_x_date(date_breaks="2 months", 
               date_labels = "%b '%y", 
               minor_breaks = NULL) +
  labs(title = "LARC Prescriptions Issued by NHS \n Scotland from Jan 2020 to Jul 2022", 
       x = "Month and Year Prescription Dispensed", 
       y = "Sum of Prescriptions Issued") +
  ThemeElliot()

EmergencyContraceptionZoomPlot <- Zoom(EmergencyContraception) %>%
  ggplot(aes(x = PaidDateMonth, y = SumPaidQuantity)) +
  AnnotateLockdowns() +
  geom_line(colour = "#0391BF") +
  geom_point(colour = "#0391BF", shape = 1) +
  scale_x_date(date_breaks = "2 months", date_labels = "%b '%y", minor_breaks = NULL) +
  scale_y_continuous() +
    labs(title = "Emergency Contraception Prescriptions Issued by NHS \n Scotland from Jan 2020 to Jul 2022", 
       x = "Month and Year Prescription Dispensed", 
       y = "Sum of Prescriptions Issued") +
  ThemeElliot()

TabletZoomPlot <- Zoom(Tablet) %>% 
  ggplot(aes(x = PaidDateMonth, y = SumPaidQuantity)) +
  AnnotateLockdowns() +
  geom_line(colour = "#0391BF") +
  geom_point(colour = "#0391BF", shape = 1) +
  scale_y_continuous() +
    scale_x_date(date_breaks="2 months", 
               date_labels = "%b '%y", 
               minor_breaks = NULL) +
    labs(title = "Oral Contraceptive Prescriptions Issued by NHS \n Scotland from Jan 2020 to Jul 2022", 
       x = "Month and Year Prescription Dispensed", 
       y = "Sum of Prescriptions Issued") +
    ThemeElliot()

ZoomedPlots <- wrap_plots(ContraceptivesLogPlot, LARCZoomPlot/TabletZoomPlot/EmergencyContraceptionZoomPlot) +
plot_layout(widths = c(1,2)) + 
  plot_annotation(
    caption = 'N.B. Scales are free on these plots. Yellow shaded areas indicate national lockdowns in Scotland. Green shaded areas indicate the month after the preceding lockdowns were lifted.',
 tag_levels = 'A',
    title = "Change in Prescribing Rates of Different Types of Contraception in Scotland over Covid-19 Lockdowns",
 theme = theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 18), plot.margin = margin(5, 5, 5, 5)))

ZoomedPlots

#Need to annotate lines on Log Graph and change colours of B-D to match
```

```{r}

```

